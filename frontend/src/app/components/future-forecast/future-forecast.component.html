<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="bi bi-calendar-week"></i> Future Workload Forecast</h2>
    <button class="btn btn-primary" (click)="loadForecast()">
      <i class="bi bi-arrow-clockwise"></i> Refresh
    </button>
  </div>

  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <div *ngIf="!loading && forecast">
    <!-- Summary Cards -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="card bg-primary text-white">
          <div class="card-body">
            <h3 class="card-title">{{ forecast.summary.totalWeeksAnalyzed }}</h3>
            <p class="card-text">Weeks Analyzed</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card" [class.bg-danger]="forecast.summary.bottlenecksDetected > 0" 
             [class.bg-success]="forecast.summary.bottlenecksDetected === 0" 
             class="text-white">
          <div class="card-body">
            <h3 class="card-title">{{ forecast.summary.bottlenecksDetected }}</h3>
            <p class="card-text">Critical Bottlenecks</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-warning text-dark">
          <div class="card-body">
            <h3 class="card-title">{{ forecast.summary.warningsIssued }}</h3>
            <p class="card-text">Warnings Issued</p>
          </div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="card bg-info text-white">
          <div class="card-body">
            <h5 class="card-title mb-0">Week {{ forecast.summary.peakWeek.week }}</h5>
            <p class="card-text mb-0">Peak Workload Week</p>
            <small>{{ forecast.summary.peakWeek.totalTasks }} tasks due</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Critical Bottlenecks Alert -->
    <div *ngIf="forecast.bottlenecks.length > 0" class="alert alert-danger mb-4">
      <h5 class="alert-heading"><i class="bi bi-exclamation-triangle-fill"></i> Critical Bottlenecks Detected</h5>
      <div *ngFor="let bottleneck of forecast.bottlenecks" class="mb-2">
        <strong>{{ bottleneck.recommendation }}</strong>
        <ul class="mb-0 mt-1">
          <li *ngFor="let emp of bottleneck.employees">
            {{ emp.name }}: {{ emp.projectedUtilization | number:'1.0-0' }}% utilization 
            ({{ emp.tasksDue }} tasks due)
          </li>
        </ul>
      </div>
    </div>

    <!-- Warnings -->
    <div *ngIf="forecast.warnings.length > 0 && forecast.bottlenecks.length === 0" class="alert alert-warning mb-4">
      <h5 class="alert-heading"><i class="bi bi-exclamation-circle"></i> Workload Warnings</h5>
      <ul class="mb-0">
        <li *ngFor="let warning of forecast.warnings">
          {{ warning.recommendation }}
        </li>
      </ul>
    </div>

    <!-- Success Message -->
    <div *ngIf="forecast.bottlenecks.length === 0 && forecast.warnings.length === 0" class="alert alert-success mb-4">
      <h5 class="alert-heading"><i class="bi bi-check-circle-fill"></i> No Critical Issues Predicted</h5>
      <p class="mb-0">Workload appears balanced for the next {{ forecast.summary.totalWeeksAnalyzed }} weeks.</p>
    </div>

    <!-- Weekly Timeline -->
    <div class="card mb-4">
      <div class="card-header">
        <h5><i class="bi bi-calendar3"></i> 8-Week Timeline</h5>
      </div>
      <div class="card-body">
        <div class="timeline-container">
          <div *ngFor="let week of forecast.weeklyForecast" 
               class="timeline-week"
               [class.selected]="selectedWeek?.week === week.week"
               [class.critical]="hasBottleneck(week)"
               (click)="selectWeek(week)">
            <div class="week-number">Week {{ week.week }}</div>
            <div class="week-date">{{ week.startDate | date:'MMM d' }}</div>
            <div class="week-stats">
              <small>{{ week.totalTasks }} tasks</small>
              <small *ngIf="week.criticalTasks > 0" class="text-danger">
                {{ week.criticalTasks }} urgent
              </small>
            </div>
            <div class="week-indicator" 
                 [class.bg-danger]="hasBottleneck(week)"
                 [class.bg-warning]="!hasBottleneck(week) && hasOverloaded(week)"
                 [class.bg-success]="isAllBalanced(week)">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Selected Week Details -->
    <div *ngIf="selectedWeek" class="card">
      <div class="card-header bg-primary text-white">
        <h5><i class="bi bi-calendar-event"></i> Week {{ selectedWeek.week }} Details 
          ({{ selectedWeek.startDate | date:'mediumDate' }} - {{ selectedWeek.endDate | date:'mediumDate' }})</h5>
      </div>
      <div class="card-body">
        <div class="row g-2 mb-4">
          <div class="col-md-3">
            <div class="stat-box">
              <div class="stat-value">{{ selectedWeek.totalTasks }}</div>
              <div class="stat-label">Total Tasks Due</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box">
              <div class="stat-value text-danger">{{ selectedWeek.criticalTasks }}</div>
              <div class="stat-label">Critical Tasks</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box">
              <div class="stat-value">{{ selectedWeek.estimatedHours | number:'1.0-0' }}h</div>
              <div class="stat-label">Estimated Hours</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-box">
              <div class="stat-value">{{ selectedWeek.employeeForecasts.length }}</div>
              <div class="stat-label">Employees with Tasks</div>
            </div>
          </div>
        </div>

        <!-- Employee Forecasts -->
        <h6 class="mb-3">Employee Projections</h6>
        <div *ngIf="selectedWeek.employeeForecasts.length === 0" class="text-muted text-center py-3">
          No tasks due this week
        </div>
        <div class="table-responsive" *ngIf="selectedWeek.employeeForecasts.length > 0">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Employee</th>
                <th>Current Utilization</th>
                <th>Projected Utilization</th>
                <th>Tasks Due</th>
                <th>Hours Required</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let emp of selectedWeek.employeeForecasts"
                  [class.table-danger]="emp.isBottleneck"
                  [class.table-warning]="emp.status === 'Overloaded' && !emp.isBottleneck">
                <td>
                  <strong>{{ emp.employeeName }}</strong>
                  <i *ngIf="emp.isBottleneck" class="bi bi-exclamation-triangle-fill text-danger ms-2"></i>
                </td>
                <td>
                  <span class="badge bg-secondary">{{ emp.currentUtilization | number:'1.0-0' }}%</span>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="progress flex-grow-1 me-2" style="height: 20px; width: 100px;">
                      <div class="progress-bar"
                           [class]="'bg-' + getStatusClass(emp.status)"
                           [style.width.%]="Math.min(100, emp.projectedUtilization)"
                           role="progressbar">
                      </div>
                    </div>
                    <strong [class]="'text-' + getStatusClass(emp.status)">
                      {{ emp.projectedUtilization | number:'1.0-0' }}%
                    </strong>
                  </div>
                </td>
                <td>{{ emp.tasksDue }}</td>
                <td>{{ emp.hoursRequired | number:'1.1-1' }}h</td>
                <td>
                  <span class="badge" [class]="'bg-' + getStatusClass(emp.status)">
                    {{ emp.status }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
